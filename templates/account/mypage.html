{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'account/css/mypage.css' %}">
<script src="{% static 'account/js/mypage.js' %}"></script>
{% endblock %}


{% block content %}
<div class="mypage-wrapper">
  <div class="mypage-container">

    <h2 class="header-area">
      <span>ğŸ™‹ ë‚´ ì •ë³´</span>
      <span class="header-meta">Created: {{ account.created_at }} | Updated: {{ account.updated_at }}</span>
    </h2>

    <div class="card">
      <div class="tabbar" role="tablist">
        <button class="tabbtn" type="button" role="tab" data-tab="profile" aria-selected="true">í”„ë¡œí•„</button>
        <button class="tabbtn" type="button" role="tab" data-tab="edit" aria-selected="false">ë‚´ì •ë³´ ìˆ˜ì •</button>
        <button class="tabbtn" type="button" role="tab" data-tab="receipt" aria-selected="false">ì˜ìˆ˜ì¦</button>
      </div>

      <div class="tabpanel active" id="tab-profile">
        <div class="section">
          <div class="grid2">
            <div class="label">ì•„ì´ë””</div>
            <div class="value-strong">{{ user_obj.username }}</div>

            <div class="label">ì „í™”ë²ˆí˜¸</div>
            <div>
              {% if formatted_phone %}<span class="value-strong">{{ formatted_phone }}</span>
              {% else %}<span class="mypage-phone-empty">ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ ì—†ìŒ</span>{% endif %}
            </div>

            <div class="label">ë°°ì†¡ì§€ ê´€ë¦¬</div>
            <div class="mypage-address-stack">
              {% for addr in addresses %}
                <div class="addr-list-item {% if addr.is_default %}addr-default{% else %}addr-normal{% endif %}">
                  <div class="mypage-flex-main">
                    <div class="value-strong">
                      {{ addr.alias }}{% if addr.is_default %}<span class="badge-default">ê¸°ë³¸</span>{% endif %}
                    </div>
                    <div class="mypage-addr-line">{{ addr.address }}</div>
                  </div>
                  {% if not addr.is_default %}
                    <form method="post" action="{% url 'address_delete' addr.id %}" class="mypage-form-nomargin">
                      {% csrf_token %}
                      <button type="submit" class="btn-danger" onclick="return confirm('[{{ addr.alias }}] ë°°ì†¡ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                    </form>
                  {% endif %}
                </div>
              {% endfor %}

              <div class="pagination">
                {% if addresses.has_previous %}
                  <a href="?tab=profile&addr_page={{ addresses.previous_page_number }}" class="page-link">ì´ì „</a>
                {% else %}<span class="page-disabled">ì´ì „</span>{% endif %}
                <span class="mypage-pagination-current">{{ addresses.number }} / {{ addresses.paginator.num_pages }}</span>
                {% if addresses.has_next %}
                  <a href="?tab=profile&addr_page={{ addresses.next_page_number }}" class="page-link">ë‹¤ìŒ</a>
                {% else %}<span class="page-disabled">ë‹¤ìŒ</span>{% endif %}
              </div>
              <p class="help">â€» ê¸°ë³¸ ë°°ì†¡ì§€ëŠ” ì‚­ì œ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚˜ì§€ ì•Šìœ¼ë©°, ìˆ˜ì •ì€ 'ë‚´ ì •ë³´ ìˆ˜ì •' íƒ­ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
          </div>

          <div class="divider"></div>

          <div class="mypage-account-head">
            <h3 class="mypage-section-title">ğŸ¦ í˜„ì¬ ë‚´ ê³„ì¢Œ</h3>
            <div class="mypage-section-hint">{% if accounts|length > 1 %}ê³„ì¢Œ ì„ íƒ ê°€ëŠ¥{% else %}ê¸°ë³¸ ê³„ì¢Œ í‘œì‹œ{% endif %}</div>
          </div>

          <div class="mypage-account-stack">
            {% if accounts %}
              <form method="post" action="{% url 'account_set_default' 0 %}" autocomplete="off" class="js-default-account-form" data-action-template="{% url 'account_set_default' 0 %}">
                {% csrf_token %}
                <div class="input-wrap">
                  <select name="account_id"
                          class="mypage-select-default js-default-account-select">
                    {% for acc in accounts %}
                      <option value="{{ acc.id }}" {% if acc.is_default %}selected{% endif %}>
                        {{ acc.bank }} / {{ acc.masked_account_number }}{% if acc.is_default %} (ê¸°ë³¸){% endif %}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <p class="help">â€» ê³„ì¢Œë¥¼ ì„ íƒí•˜ë©´ ê¸°ë³¸ ê³„ì¢Œê°€ ë³€ê²½ë©ë‹ˆë‹¤.</p>
              </form>

              
              <div class="mypage-account-del-list">
                {% for acc in accounts %}
                  {% if not acc.is_default %}
                    <form method="post" action="{% url 'account_delete' acc.id %}" class="mypage-form-nomargin">
                      {% csrf_token %}
                      <button type="submit" class="btn-small-del" onclick="return confirm('ì´ ê³„ì¢Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                        {{ acc.bank }} {{ acc.masked_account_number }} ì‚­ì œ
                      </button>
                    </form>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="divider mypage-divider-lg"></div>

          <div class="mypage-section-plain">
            <h3 class="mypage-section-title mypage-section-title-gap">ğŸ¦ ìƒì„¸ ì •ë³´</h3>
            {% if account %}
              <div class="grid2">
                <div class="label">ì˜ˆê¸ˆì£¼ëª…</div><div class="value-strong">{{ account.name }}</div>
                <div class="label">ì€í–‰</div><div class="value-strong">{{ account.bank }}</div>
                <div class="label">ê³„ì¢Œë²ˆí˜¸</div><div class="value-strong">{{ account.masked_account_number }}</div>
                <div class="label">ì”ì•¡</div>
                <div class="balance-row">
                  <div class="balance-text">{{ default_account.balance|intcomma }}ì›</div>
                  <a href="#recharge-modal" class="btn-recharge">ì¶©ì „</a>
                </div>
              </div>
            {% else %}
              <div class="receipt-memo">ë“±ë¡ëœ ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="tabpanel" id="tab-edit">
        <div class="section">
          <div class="mypage-edit-head">
            <h3 class="mypage-section-title">âœï¸ ë‚´ì •ë³´ ìˆ˜ì •</h3>
            <span class="mypage-section-hint">ì „í™”ë²ˆí˜¸ / ê³„ì¢Œ / ë°°ì†¡ì§€</span>
          </div>

          <form id="mypageUpdateForm" method="post" action="{% url 'mypage_update' %}" autocomplete="off">{% csrf_token %}</form>

          <div class="mypage-edit-stack">
            <div class="addr-normal mypage-card-pad">
              <div class="label mypage-label-gap">ì „í™”ë²ˆí˜¸</div>
              <div class="input-wrap">
                <input form="mypageUpdateForm" name="phone" value="{{ account.phone|default:'' }}" placeholder="01012345678" />
              </div>
              <p class="help">â€» ë‚´ì •ë³´ ìˆ˜ì • ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</p>
            </div>

            <div class="addr-normal mypage-card-pad">
              <div class="value-strong mypage-value-gap">â• ìƒˆ ê³„ì¢Œ ì¶”ê°€</div>
              <form method="post" action="{% url 'account_add' %}" class="mypage-form-stack">
                {% csrf_token %}
                <div class="input-wrap"><select name="bank" class="mypage-select-bold">
                  <option value="">ì€í–‰ ì„ íƒ</option>
                  {% for b in banks %}<option value="{{ b.id }}">{{ b.name }}</option>{% endfor %}
                </select></div>
                <div class="input-wrap"><input name="account_number" placeholder="ê³„ì¢Œë²ˆí˜¸ ì…ë ¥" /></div>
                <button class="btn-primary" type="submit">ê³„ì¢Œ ì¶”ê°€</button>
              </form>
              <p class="help mypage-help-gap">
                â€» ë™ì¼ ê³„ì¢Œë²ˆí˜¸ëŠ” ì¤‘ë³µ ë“±ë¡í•  ìˆ˜ ì—†ìœ¼ë©°, íƒ€ì¸ ê³„ì •ì— ë“±ë¡ëœ ê³„ì¢Œë„ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              </p>
            </div>

            <div class="addr-normal mypage-card-pad">
              <h3 class="mypage-section-title mypage-section-title-gap">ğŸ  ë°°ì†¡ì§€ ì •ë³´ ìˆ˜ì •</h3>
              {% for addr in edit_addresses %}
                <div class="mypage-edit-box">
                  <input form="mypageUpdateForm" type="hidden" name="address_id[]" value="{{ addr.id }}">
                  <div class="mypage-form-stack">
                    <div class="input-wrap"><input form="mypageUpdateForm" name="address_alias[]" value="{{ addr.alias }}"></div>
                    <div class="mypage-grid-form">
                      <div class="input-wrap"><input form="mypageUpdateForm" name="zip_code[]" value="{{ addr.zip_code }}"></div>
                      <div class="input-wrap"><input form="mypageUpdateForm" name="address[]" value="{{ addr.address }}"></div>
                    </div>
                    <div class="input-wrap"><input form="mypageUpdateForm" name="detail_address[]" value="{{ addr.detail_address }}"></div>
                  </div>
                </div>
              {% endfor %}
              
              <div class="pagination mypage-margin-b20">
                {% if edit_addresses.has_previous %}
                  <a href="?tab=edit&edit_addr_page={{ edit_addresses.previous_page_number }}" class="page-link">ì´ì „</a>
                {% endif %}
                <span class="mypage-pagination-current">{{ edit_addresses.number }} / {{ edit_addresses.paginator.num_pages }}</span>
                {% if edit_addresses.has_next %}
                  <a href="?tab=edit&edit_addr_page={{ edit_addresses.next_page_number }}" class="page-link">ë‹¤ìŒ</a>
                {% endif %}
              </div>

              <div class="divider"></div>
              <h3 class="mypage-section-title mypage-section-title-topgap">â• ìƒˆ ë°°ì†¡ì§€ ì¶”ê°€</h3>
              <div class="mypage-newaddr-box">
                <div class="input-wrap"><input form="mypageUpdateForm" name="new_alias" placeholder="ë°°ì†¡ì§€ ì´ë¦„"></div>
                <div class="input-wrap"><input form="mypageUpdateForm" name="new_zip_code" placeholder="ìƒˆ ìš°í¸ë²ˆí˜¸"></div>
                <div class="input-wrap"><input form="mypageUpdateForm" name="new_address" placeholder="ìƒˆ ê¸°ë³¸ ì£¼ì†Œ"></div>
                <div class="input-wrap"><input form="mypageUpdateForm" name="new_detail_address" placeholder="ìƒˆ ìƒì„¸ ì£¼ì†Œ"></div>
              </div>

              <div class="mypage-btn-row">
                <button type="button" class="btn-ghost" onclick="location.href='?tab=profile'" class="mypage-flex-1">ì·¨ì†Œ</button>
                <button type="submit" class="btn-primary" form="mypageUpdateForm" class="mypage-flex-1">ì €ì¥</button>
              </div>
            </div>

            <div class="addr-normal mypage-card-pad">
              <h3 class="mypage-section-title mypage-section-title-gap">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
              <div class="info-box-blue">ì•ˆì „ì„ ìœ„í•´ <b>ë³¸ì¸ ì¸ì¦</b> í›„ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
              {% if not pw_verified %}
                <form method="post" action="{% url 'pw_verify' %}">
                  {% csrf_token %}
                  <div class="mypage-margin-b12">
                    <div class="label mypage-label-gap">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</div>
                    <div class="input-wrap"><input type="password" name="current_password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" /></div>
                  </div>
                  <button type="submit" class="btn-primary mypage-w-100">ë³¸ì¸ ì¸ì¦</button>
                </form>
              {% else %}
                <form method="post" action="{% url 'pw_change' %}">
                  {% csrf_token %}
                  <div class="mypage-stack-14-b12">
                    <div><div class="label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</div><div class="input-wrap"><input type="password" name="new_password1" /></div></div>
                    <div><div class="label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</div><div class="input-wrap"><input type="password" name="new_password2" /></div></div>
                  </div>
                  <div class="mypage-btn-row">
                    <a href="/accounts/mypage/?tab=edit" class="btn-ghost mypage-btn-link">ì·¨ì†Œ</a>
                    <button type="submit" class="btn-primary mypage-flex-1">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                  </div>
                </form>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="tabpanel" id="tab-receipt">
        <div class="section">
          <h3 class="mypage-section-title mypage-section-title-gap">ğŸ§¾ ì˜ìˆ˜ì¦</h3>
          <p class="help mypage-margin-b14">êµ¬ë§¤(ì¶œê¸ˆ) ê±°ë˜ ë‚´ì—­ì„ ê¸°ë°˜ìœ¼ë¡œ ì˜ìˆ˜ì¦(PDF)ì„ ë°œê¸‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <form method="get" class="mypage-receipt-filter">
          <input type="hidden" name="tab" value="receipt">

          <div class="mypage-receipt-filter-row">
            <div class="mypage-filter-group">
              <div class="label mypage-label-gap">ê¸°ê°„</div>
              <div class="mypage-filter-dates">
                <div class="input-wrap">
                  <input type="date" name="rc_start" value="{{ rc_start }}">
                </div>
                <span class="mypage-date-tilde">~</span>
                <div class="input-wrap">
                  <input type="date" name="rc_end" value="{{ rc_end }}">
                </div>
              </div>
            </div>

            <div class="mypage-filter-group">
              <div div class="label mypage-label-gap">ì¹´í…Œê³ ë¦¬</div>
              <div class="input-wrap">
                <select name="rc_category">
                    <option value="">ì „ì²´</option>
                  {% for c in receipt_categories %}
                    <option value="{{ c.id }}" {% if rc_category == c.id|stringformat:"i" %}selected{% endif %}>
                      {{ c.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="mypage-filter-actions">
              <button type="submit" class="btn-primary">ì ìš©</button>
                <a href="?tab=receipt" class="btn-ghost mypage-btn-link">ì´ˆê¸°í™”</a>
            </div>
          </div>
        </form>

          {% if receipts_page and receipts_page.object_list %}
            <div class="mypage-form-stack">
              {% for tx in receipts_page %}
                <div class="addr-normal mypage-card-pad">
                  <div class="mypage-receipt-row">
                    <div class="mypage-min-w0">
                      <div class="value-strong mypage-ellipsis">
                        {{ tx.product_name|default:"êµ¬ë§¤" }} {% if tx.quantity %}({{ tx.quantity }}ê°œ){% endif %}
                        {% if tx.used_coupon or tx.discount_amount %}<span class="receipt-badge-discount">í• ì¸</span>{% endif %}
                      </div>
                      <div class="help">{{ tx.occurred_at|date:"Y-m-d H:i" }}{% if tx.merchant %} Â· {{ tx.merchant }}{% endif %}{% if tx.category %} Â· {{ tx.category.name }}{% endif %}</div>
                      <div class="mypage-receipt-amount">-{{ tx.amount|intcomma }}ì›</div>
                    </div>
                    <div class="mypage-receipt-actions">
                      <a href="{% url 'receipt_pdf' tx.id %}" target="_blank" class="page-link mypage-font-13">PDF ë³´ê¸°</a>
                      <a href="{% url 'receipt_pdf' tx.id %}" download class="btn-primary mypage-font-13-link">ë‹¤ìš´ë¡œë“œ</a>
                      <form method="post" action="{% url 'receipt_hide' tx.id %}" class="mypage-form-nomargin">
                        {% csrf_token %}
                        <button type="submit" class="btn-danger" onclick="return confirm('ì˜ìˆ˜ì¦ì„ ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?');">ì˜ìˆ˜ì¦ ì‚­ì œ</button>
                      </form>
                    </div>
                  </div>
                  {% if tx.memo %}<div class="receipt-memo">{{ tx.memo }}</div>{% endif %}
                </div>
              {% endfor %}
            </div>
            {% if receipts_page.has_other_pages %}
            <div class="pagination mypage-margin-b20">
              {% if receipts_page.has_previous %}
                <a class="page-link"
                  href="?tab=receipt&rc_page={{ receipts_page.previous_page_number }}{% if rc_start %}&rc_start={{ rc_start }}{% endif %}{% if rc_end %}&rc_end={{ rc_end }}{% endif %}{% if rc_category %}&rc_category={{ rc_category }}{% endif %}">
                  ì´ì „
                </a>
              {% else %}
                <span span class="page-disabled">ì´ì „</span>
              {% endif %}

              <span class="mypage-pagination-current">
                {{ receipts_page.number }} / {{ receipts_page.paginator.num_pages }}
              </span>

              {% if receipts_page.has_next %}
                <a class="page-link"
                  href="?tab=receipt&rc_page={{ receipts_page.next_page_number }}{% if rc_start %}&rc_start={{ rc_start }}{% endif %}{% if rc_end %}&rc_end={{ rc_end }}{% endif %}{% if rc_category %}&rc_category={{ rc_category }}{% endif %}">
                  ë‹¤ìŒ
                </a>
              {% else %}
                <span class="page-disabled">ë‹¤ìŒ</span>
              {% endif %}
            </div>
            {% endif %}

          {% else %}
            <div class="receipt-memo">ì˜ìˆ˜ì¦ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  (function(){
    const tabs = document.querySelectorAll(".tabbtn");
    const panels = {
      profile: document.getElementById("tab-profile"),
      edit: document.getElementById("tab-edit"),
      receipt: document.getElementById("tab-receipt"),
    };

    function setActive(name){
      tabs.forEach(b => b.setAttribute("aria-selected", b.dataset.tab === name ? "true" : "false"));
      Object.keys(panels).forEach(k => {
          if(panels[k]) panels[k].classList.toggle("active", k === name);
      });
    }

    const params = new URLSearchParams(location.search);
    setActive(params.get("tab") || "profile");

    tabs.forEach(b => {
      b.addEventListener("click", () => {
        const name = b.dataset.tab;
        params.set("tab", name);
        history.replaceState({}, "", `${location.pathname}?${params.toString()}`);
        setActive(name);
      });
    });
  })();
</script>
{% endblock %}