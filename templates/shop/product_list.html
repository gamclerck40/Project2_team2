{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'shop/css/shop.css' %}">
<link rel="stylesheet" href="{% static 'shop/css/coupon.css' %}">

{% endblock %}

{% block content %}
<form method="get" action="." id="filter-form">
    <div class="search-container">
        <div class="search-box">
            <input type="text" name="search" value="{{ request.GET.search|default:'' }}" placeholder="ì°¾ìœ¼ì‹œëŠ” ìƒí’ˆì´ ìˆìœ¼ì‹ ê°€ìš”?" class="search-input">
            <button type="submit" class="search-btn">ê²€ìƒ‰</button>
        </div>
    </div>
    
    <div class="filter-bar">
        <select name="category" onchange="this.form.submit()" class="select-styled">
            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
            {% for category in categories %}
                <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"i" %}selected{% endif %}>{{ category.name }}</option>
            {% endfor %}
        </select>
            
        <select name="sort" onchange="this.form.submit()" class="select-styled">
            <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
            <option value="price_low" {% if request.GET.sort == 'price_low' %}selected{% endif %}>ê°€ê²© ë‚®ì€ ìˆœ</option>
            <option value="price_high" {% if request.GET.sort == 'price_high' %}selected{% endif %}>ê°€ê²© ë†’ì€ ìˆœ</option>
        </select>
    </div>
</form>

{% if display_coupon %}
<div class="slide-wrapper">
    {% for coupon in display_coupon %}
    <input type="radio" name="slider" id="slide-{{ forloop.counter }}" class="slide-input" {% if forloop.first %}checked{% endif %}>
    {% endfor %}

    <div class="coupon-container">
        {% for coupon in display_coupon %}
            <div class="coupon-item">
                {% if not forloop.first %}
                    <label for="slide-{{ forloop.counter0 }}" class="nav-btn prev-btn">â®</label>
                {% endif %}

                <a href="{% url 'register_coupon' %}" class="coupon-link">
                    <div class="coupon-banner">
                        <img src="https://images.unsplash.com/photo-1607082349566-187342175e2f?auto=format&fit=crop&w=1200&q=80" class="coupon-bg-img">
                        <div class="coupon-content"> 
                            <div class="coupon-info">
                                <div class="coupon-info-row">
                                    <span class="coupon-badge">SPECIAL</span>
                                    <span class="coupon-discount">
                                        {% if coupon.discount_type == 'amount' %}{{ coupon.discount_value|intcomma }}ì›{% else %}{{ coupon.discount_value }}%{% endif %} í• ì¸
                                    </span>
                                </div>
                                <h3 class="coupon-title">{{ coupon.name }}</h3>
                                <p class="coupon-valid">ğŸ“… ~ {{ coupon.valid_to|date:"Y.m.d" }}</p>
                            </div>

                            <div class="coupon-code-box"> 
                                <div class="coupon-code-label">Coupon Code</div>
                                <div class="coupon-code-value">{{ coupon.code }}</div>
                            </div>
                        </div>
                    </div>
                </a>

                {% if not forloop.last %}
                    <label for="slide-{{ forloop.counter|add:1 }}" class="nav-btn next-btn">â¯</label>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}
    
<h2>ğŸ›ï¸ íŒë§¤ ì¤‘ì¸ ìƒí’ˆë“¤</h2>
<hr>
    
<div class="product-grid"> 
    {% for product in products %}
        <div class="product-card">
            <div class="product-img-wrapper">
                {% if product.image1 %}
                    <img src="{{ product.image1.url }}">
                {% else %}
                    <div class="product-no-image">No Image</div>
                {% endif %}
            </div>
            <div class="product-info">
                <h3 class="product-name">{{ product.name }}</h3>
                <p class="product-price">{{ product.price|intcomma }}ì›</p>
            </div>
            <a href="{% url 'product_detail' product.pk %}" class="btn-detail">ìƒì„¸ë³´ê¸°</a>
        </div>
    {% empty %}
        <div class="product-empty-msg">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
    {% endfor %}
</div>
{% if is_paginated %}
  <nav class="pagination">
    {% if page_obj.has_previous %}
      <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">â† ì´ì „</a>
    {% else %}
      <span class="page-link disabled">â† ì´ì „</span>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <span class="page-link active">{{ num }}</span>
      {% else %}
        <a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">{{ num }}</a>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">ë‹¤ìŒ â†’</a>
    {% else %}
      <span class="page-link disabled">ë‹¤ìŒ â†’</span>
    {% endif %}
  </nav>
{% endif %}
{% endblock %}
{% block extra_js %}
<script>
(function(){
  const wrapper = document.querySelector('.slide-wrapper');
  if(!wrapper) return;

  const container = wrapper.querySelector('.coupon-container');
  const radios = wrapper.querySelectorAll('input.slide-input');
  const count = radios.length || 1;

  wrapper.style.setProperty('--coupon-count', count);

  function setIndexFromChecked(){
    let idx = 0;
    radios.forEach((r,i)=>{ if(r.checked) idx = i; });
    wrapper.style.setProperty('--coupon-index', idx);
  }

  radios.forEach(r => r.addEventListener('change', setIndexFromChecked));
  setIndexFromChecked();
})();
</script>
{% endblock %}
