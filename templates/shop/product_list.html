{% extends 'base.html' %}
{% block title %}ìƒí’ˆ ëª©ë¡{% endblock %}
{% load humanize %}

{% block content %}
<style>
    /* 1. ìŠ¬ë¼ì´ë” ì™¸ê³½ ì»¨í…Œì´ë„ˆ */
    .slide-wrapper {
        position: relative;
        width: 100%;
        height: 180px; /* ê·¸ë¦¼ì ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ì•½ê°„ ë†’ì„ */
        margin: 20px 0 40px 0;
        overflow: hidden; /* ì˜ì—­ ë°– ì¿ í° ìˆ¨ê¹€ */
        border-radius: 20px;
    }

    /* 2. ë¼ë””ì˜¤ ë²„íŠ¼(ìˆ¨ê¹€) */
    .slide-input {
        display: none;
    }

    /* 3. ì¿ í°ë“¤ì´ ê°€ë¡œë¡œ ë°°ì¹˜ë  íŠ¸ë™ */
    .coupon-container {
        display: flex;
        /* ì¿ í° ê°œìˆ˜ì— ë¹„ë¡€í•˜ì—¬ ë„ˆë¹„ ì„¤ì • */
        width: calc(100% * {{ display_coupon|length|default:1 }});
        height: 170px;
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* ë¶€ë“œëŸ¬ìš´ ì´ë™ */
    }

    .coupon-item {
        /* ì „ì²´ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ë¥¼ ì¿ í° ê°œìˆ˜ë¡œ ë‚˜ëˆ” */
        width: calc(100% / {{ display_coupon|length|default:1 }});
        flex-shrink: 0;
        position: relative;
    }

    /* 4. í•µì‹¬ ë¡œì§: ë¼ë””ì˜¤ ë²„íŠ¼ì´ ì²´í¬ë˜ë©´ í•´ë‹¹ ìˆœì„œë¡œ íŠ¸ë™ ì´ë™ */
    {% for coupon in display_coupon %}
    #slide-{{ forloop.counter }}:checked ~ .coupon-container {
        transform: translateX(calc(-100% / {{ display_coupon|length|default:1 }} * {{ forloop.counter0 }}));
    }
    {% endfor %}

    /* 5. í™”ì‚´í‘œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (label) */
    .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.85);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #222;
        font-size: 18px;
        font-weight: bold;
        z-index: 20;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: all 0.2s;
        user-select: none;
    }
    .nav-btn:hover {
        background: #fff;
        transform: translateY(-50%) scale(1.1);
    }
    .prev-btn { left: 15px; }
    .next-btn { right: 15px; }
</style>

<form method="get" action="." id="filter-form">
    <div style="display: flex; justify-content: center; margin: 30px 0 50px 0;">
        <div style="display: flex; width: 100%; max-width: 600px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 30px; overflow: hidden; background: white;">
            <input type="text" name="search" value="{{ request.GET.search|default:'' }}" placeholder="ì°¾ìœ¼ì‹œëŠ” ìƒí’ˆì´ ìˆìœ¼ì‹ ê°€ìš”?" 
                   style="flex: 1; padding: 15px 25px; border: none; outline: none; font-size: 16px;">
            <button type="submit" style="padding: 0 30px; background: #333; color: white; border: none; cursor: pointer; font-weight: bold;">ê²€ìƒ‰</button>
        </div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px;">
        <select name="category" onchange="this.form.submit()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
            {% for category in categories %}
                <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"i" %}selected{% endif %}>{{ category.name }}</option>
            {% endfor %}
        </select>
            
        <select name="sort" onchange="this.form.submit()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
            <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
            <option value="price_low" {% if request.GET.sort == 'price_low' %}selected{% endif %}>ê°€ê²© ë‚®ì€ ìˆœ</option>
            <option value="price_high" {% if request.GET.sort == 'price_high' %}selected{% endif %}>ê°€ê²© ë†’ì€ ìˆœ</option>
        </select>
    </div>
</form>

{% if display_coupon %}
<div class="slide-wrapper">
    {% for coupon in display_coupon %}
    <input type="radio" name="slider" id="slide-{{ forloop.counter }}" class="slide-input" {% if forloop.first %}checked{% endif %}>
    {% endfor %}

    <div class="coupon-container">
        {% for coupon in display_coupon %}
            <div class="coupon-item">
                
                {% if not forloop.first %}
                    <label for="slide-{{ forloop.counter0 }}" class="nav-btn prev-btn">â®</label>
                {% endif %}

                <a href="{% url 'register_coupon' %}" style="text-decoration: none; display: block;">
                    <div style="position: relative; width: 100%; height: 170px; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 10px 25px rgba(0,0,0,0.15);">
                        <img src="https://images.unsplash.com/photo-1607082349566-187342175e2f?auto=format&fit=crop&w=1200&q=80" 
                             style="width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: brightness(0.6);">
                        
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 80px 0 40px; color: white; box-sizing: border-box;"> 
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <span style="background: #e44d26; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">SPECIAL</span>
                                    <span style="color: #ffcc00; font-weight: 800; font-size: 16px;">
                                        {% if coupon.discount_type == 'amount' %}{{ coupon.discount_value|intcomma }}ì›{% else %}{{ coupon.discount_value }}%{% endif %} í• ì¸
                                    </span>
                                </div>
                                <h3 style="margin: 0; font-size: 22px; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ coupon.name }}</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.8; font-size: 12px;">ğŸ“… ~ {{ coupon.valid_to|date:"Y.m.d" }}</p>
                            </div>

                            <div style="background: white; padding: 12px 20px; border-radius: 12px; text-align: center; min-width: 140px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"> 
                                <div style="color: #999; font-size: 9px; font-weight: bold; text-transform: uppercase;">Coupon Code</div>
                                <div style="color: #222; font-size: 18px; font-weight: 900; letter-spacing: 1px; font-family: 'Courier New', monospace;">{{ coupon.code }}</div>
                            </div>
                        </div>
                    </div>
                </a>

                {% if not forloop.last %}
                    <label for="slide-{{ forloop.counter|add:1 }}" class="nav-btn next-btn">â¯</label>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}
    
<h2>ğŸ›ï¸ íŒë§¤ ì¤‘ì¸ ìƒí’ˆë“¤</h2>
<hr>
    
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 40px;"> 
    {% for product in products %}
        <div style="border: 1px solid #eee; padding: 15px; border-radius: 12px; transition: all 0.2s; background: white; display: flex; flex-direction: column;">
            <div style="width: 100%; aspect-ratio: 1/1; overflow: hidden; background: #f9f9f9; border-radius: 8px; margin-bottom: 12px;">
                {% if product.image1 %}
                    <img src="{{ product.image1.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ccc;">No Image</div>
                {% endif %}
            </div>
            <div style="flex-grow: 1;">
                <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #333; font-weight: 600;">{{ product.name }}</h3>
                <p style="margin: 0; color: #e44d26; font-weight: bold; font-size: 18px;">{{ product.price|intcomma }}ì›</p>
            </div>
            <a href="{% url 'product_detail' product.pk %}" style="display: block; margin-top: 15px; padding: 8px 0; background: #f4f4f4; color: #666; text-decoration: none; text-align: center; border-radius: 6px; font-size: 14px; font-weight: 500;">ìƒì„¸ë³´ê¸°</a>
        </div>
    {% empty %}
        <div style="grid-column: span 4; text-align: center; padding: 50px 0; color: #999;">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
    {% endfor %}
</div>

{% endblock %}