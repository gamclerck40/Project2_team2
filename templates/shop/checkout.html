{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'shop/css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="checkout-wrap">
    <h2 class="checkout-title">ğŸ“¦ ì£¼ë¬¸ì„œ í™•ì¸</h2>

    <div class="checkout-layout">
        
        <div class="main-column">
            <div class="checkout-section">
                <h3 class="section-title">ì£¼ë¬¸ ìƒí’ˆ</h3>
                
                {% if product %} 
                    <div class="product-item">
                        <img src="{{ product.image1.url }}" class="product-img">
                        <div class="product-info">
                            <strong>{{ product.name }}</strong>
                            <div class="product-meta">{{ quantity }}ê°œ / {{ product.price|intcomma }}ì›</div>
                        </div>
                    </div>
                {% else %}
                    {% for item in cart_items %}
                    <div class="product-item">
                        <img src="{{ item.product.image1.url }}" class="product-img">
                        <div class="product-info">
                            <strong>{{ item.product.name }}</strong>
                            <div class="product-meta">{{ item.quantity }}ê°œ</div>
                        </div>
                        <div class="product-total-price">{{ item.total_price|intcomma }}ì›</div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="checkout-section">
                <h3 class="section-title">ê²°ì œ ì •ë³´ ì„¤ì •</h3>
                <form method="get" action="{% url 'checkout' %}" id="selection-form">
          {% if request.GET.product_id %}
            <input type="hidden" name="product_id" value="{{ request.GET.product_id }}">
            <input type="hidden" name="quantity" value="{{ request.GET.quantity|default:'1' }}">
          {% endif %}
          {% if request.GET.coupon_id %}
            <input type="hidden" name="coupon_id" value="{{ request.GET.coupon_id }}">
          {% endif %}
                    {% if product %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="quantity" value="{{ quantity }}">
                    {% endif %}
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ’³ ê²°ì œ ê³„ì¢Œ</label>
                        <select name="selected_account_id" onchange="this.form.submit()" required class="form-select">
                            {% for acc in accounts %}
                                <option value="{{ acc.id }}" {% if acc.id == account.id %}selected{% endif %}>
                                    {{ acc.bank.name }} | {{ acc.masked_account_number }} ({{ acc.balance|intcomma }}ì›)
                                </option>
                            {% empty %}
                                <option value="">ë“±ë¡ëœ ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ ì‚¬ìš©í•  ì¿ í°</label>
                        <select name="coupon_id" onchange="this.form.submit()" class="form-select">
                            <option value="">ì¿ í° ì„ íƒ ì•ˆ í•¨</option>
                            {% for uc in user_coupons %}
                                <option value="{{ uc.id }}" {% if uc.id|stringformat:"s" == selected_coupon_id %}selected{% endif %}>
                                    {{ uc.coupon.name }} 
                                    ({% if uc.coupon.discount_type == 'amount' %}-{{ uc.coupon.discount_value|intcomma }}ì›{% else %}-{{ uc.coupon.discount_value }}%{% endif %})
                                    - {{ uc.coupon.min_purchase_amount|intcomma }}ì› ì´ìƒ ì‹œ
                                </option>
                            {% endfor %}
                        </select>
                    </div>                    
                </form>
            </div>

            <form method="post" id="checkout-form">
                {% csrf_token %}
                <input type="hidden" name="selected_account_id" value="{{ account.id }}">
                <input type="hidden" name="coupon_id" value="{{ selected_coupon_id }}"> 
                {% if product %}
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    <input type="hidden" name="quantity" value="{{ quantity }}">
                {% endif %}

                <div class="checkout-section">
                    <h3 class="section-title">ë°°ì†¡ì§€ ì •ë³´</h3>
                    <select name="address_id" required class="form-select">
                        {% for addr in addresses %}
                            <option value="{{ addr.id }}">[{{ addr.alias }}] {{ addr.address }}</option>
                        {% endfor %}
                    </select>
                </div>
        </div>

        <div class="sticky-sidebar">
            <div class="summary-card">
                <h3>ê²°ì œ ìš”ì•½</h3>
                <div class="summary-row">
                    <span class="label">ì´ ìƒí’ˆ ê¸ˆì•¡</span>
                    <span>{{ total_amount|intcomma }}ì›</span>
                </div>
                <div class="summary-row">
                    <span class="discount-label">í• ì¸ ê¸ˆì•¡</span>
                    <span class="discount-value">-{{ discount_amount|intcomma }}ì›</span>
                </div>
                <div class="balance-row">
                    <span class="balance-label">ì„ íƒê³„ì¢Œ ì”ì•¡</span>
                    <div class="balance-value-wrap">
                        <span class="balance-value {% if account.balance < final_price %}balance-insufficient{% else %}balance-sufficient{% endif %}">
                            {{ account.balance|intcomma }}ì›
                        </span>
                        <a href="#recharge-modal" class="btn-recharge">ì¶©ì „</a>
                    </div>
                </div>
                <hr class="divider">
                <div class="final-price-row">
                    <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                    <span class="final-price-value">{{ final_price|intcomma }}ì›</span>
                </div>

                {% if account.balance >= final_price %}
                    <button type="submit" formaction="{% if product %}{% url 'direct_purchase' product.id %}{% else %}{% url 'order_execute' %}{% endif %}" class="btn-submit-pay">
                        ê²°ì œí•˜ê¸°
                    </button>
                {% else %}
                    <div class="warning-msg">âš ï¸ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤</div>
                    <button type="button" disabled class="btn-disabled-pay">
                        ê²°ì œ ë¶ˆê°€
                    </button>
                {% endif %}
            </div>
            </form> 
            <a href="{% url 'cart_list' %}" class="link-back">â† ì¥ë°”êµ¬ë‹ˆë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>
</div>
{% endblock %}