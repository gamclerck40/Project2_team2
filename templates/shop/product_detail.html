{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<style>
  .image-upload-wrapper {
    display: flex !important;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
  }

  .image-upload-box {
    position: relative;
    width: 80px;
    height: 80px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #fff;
    transition: all 0.2s;
  }

  .image-upload-box input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 5;
  }

  /* âœ… íŒŒì¼ì´ ì„ íƒ(valid)ë˜ì—ˆì„ ë•Œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ë³€ê²½ */
  .image-upload-box.has-file {
  border: 2px solid #e44d26;
  background-color: #fff5f2;
}

  /* âœ… íŒŒì¼ì´ ì„ íƒë˜ë©´ "No Image" ëŒ€ì‹  "Selected!" í‘œì‹œ */
  .upload-status-text {
    font-size: 11px;
    color: #999;
    pointer-events: none;
    text-align: center;
  }

  .image-upload-box.has-file .upload-status-text span {
  display: none;
}

 .image-upload-box.has-file .upload-status-text::before {
  content: "Selected!";
  color: #e44d26;
  font-weight: bold;
}
</style>

<div style="max-width: 800px; margin: 0 auto; padding: 20px;">
  <a href="{% url 'product_list' %}" style="text-decoration: none; color: #666;">
    â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
  </a>

  <div style="display: flex; gap: 40px; margin-top: 20px;">
    <div style="flex: 1;">
      {% if product.image1 %}
        <img src="{{ product.image1.url }}" style="width: 100%; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
      {% else %}
        <div style="background: #f0f0f0; height: 300px; display: flex; align-items: center; justify-content: center;">ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
      {% endif %}
      <div style="display: flex; gap: 5px; margin-top: 10px;">
        {% if product.image2 %}<img src="{{ product.image2.url }}" style="width: 19%; border-radius: 5px;">{% endif %}
        {% if product.image3 %}<img src="{{ product.image3.url }}" style="width: 19%; border-radius: 5px;">{% endif %}
        {% if product.image4 %}<img src="{{ product.image4.url }}" style="width: 19%; border-radius: 5px;">{% endif %}
        {% if product.image5 %}<img src="{{ product.image5.url }}" style="width: 19%; border-radius: 5px;">{% endif %}
      </div>
    </div>

    <div style="flex: 1;">
      <h1 style="margin-bottom: 10px;">{{ product.name }}</h1>
      <p style="font-size: 24px; color: #e44d26; font-weight: bold;">{{ product.price|intcomma }}ì›</p>
      <hr>
      <p style="line-height: 1.6; color: #333;">{{ product.description }}</p>
      <p style="color: #888;">ë‚¨ì€ ìˆ˜ëŸ‰: {{ product.stock }}ê°œ</p>
      <form method="post" style="margin-top: 20px;">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <div style="margin-bottom: 20px;">
          <label for="quantity">ìˆ˜ëŸ‰: </label>
          <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ product.stock }}" style="width: 60px; padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
        </div>
        <button type="submit" formaction="{% url 'add_to_cart' product.id %}" style="width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; margin-bottom: 10px;">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
        <button type="submit" formaction="{% url 'checkout' %}" style="width: 100%; padding: 15px; background: #e44d26; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">ë°”ë¡œ êµ¬ë§¤í•˜ê¸°</button>
      </form>
    </div>
  </div>

  <hr style="margin: 40px 0;">
  
  <h3 style="text-align: center; margin-bottom: 30px;">ìƒí’ˆ ìƒì„¸ ì„¤ëª…</h3>
  {% if product.description_image1 %}<img src="{{ product.description_image1.url }}" style="width: 100%; margin-bottom: 15px;">{% endif %}
  <p style="line-height: 1.8; margin-bottom: 30px;">{{ product.description_text1 }}</p>

  <hr style="margin: 60px 0 20px;">

  <div id="review-section" style="padding-top: 20px;">
    {% if can_review %}
      <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
        <h4 style="margin-top: 0;">ì´ ìƒí’ˆì€ ì–´ë– ì…¨ë‚˜ìš”?</h4>
        <form action="{% url 'review_create' product.id %}" method="post" enctype="multipart/form-data" novalidate>
          {% csrf_token %}
          <div style="margin-bottom: 15px;">
            <label>í‰ì : </label>
            <select name="rating" style="padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
              <option value="5">â˜…â˜…â˜…â˜…â˜… (5ì )</option>
              <option value="4">â˜…â˜…â˜…â˜… (4ì )</option>
              <option value="3">â˜…â˜…â˜… (3ì )</option>
              <option value="2">â˜…â˜… (2ì )</option>
              <option value="1">â˜… (1ì )</option>
            </select>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">ğŸ“¸ ì‚¬ì§„ ì²¨ë¶€ (ìµœëŒ€ 5ì¥)</label>
            <div class="image-upload-wrapper">
  {% for i in "12345" %}
    <div class="image-upload-box">
      <input type="file" name="review_images" accept="image/*" required 
             onchange="if(this.value) this.parentElement.classList.add('has-file'); else this.parentElement.classList.remove('has-file');">
      <div class="upload-status-text">
        <span>No Image</span>
      </div>
    </div>
  {% endfor %}
</div>
            <p style="font-size: 11px; color: #888; margin-top: 5px;">* ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ ë°•ìŠ¤ ìƒ‰ìƒì´ ë³€ê²½ë©ë‹ˆë‹¤.</p>
          </div>

          <textarea name="content" placeholder="ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." style="width: 100%; height: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ddd; resize: none; margin-bottom: 10px; box-sizing: border-box;"></textarea>
          <button type="submit" style="background: #333; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">ë¦¬ë·° ë“±ë¡í•˜ê¸°</button>
        </form>
      </div>
    {% endif %}

    <div style="margin-top: 30px;">
      {% for review in reviews %}
  <div style="border-bottom: 1px solid #eee; padding: 15px 0;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <strong>{{ review.user.username }}</strong>
        <span style="color: #ffc107;">â˜… {{ review.rating }}</span>
        <span style="color: #999; font-size: 12px;">{{ review.created_at|date:"Y.m.d" }}</span>
      </div>
      
      {% if review.user == request.user %}
        <div style="display: flex; align-items: center; gap: 5px;">
          <a href="?edit_id={{ review.id }}#review-section" style="text-decoration: none; font-size: 12px; padding: 2px 8px; background: #f0f0f0; color: #666; border-radius: 4px;">ìˆ˜ì •</a>
          
          <form action="{% url 'review_delete' review.id %}" method="post" style="margin: 0; display: inline;">
            {% csrf_token %}
            <button type="submit" style="border: none; cursor: pointer; font-size: 12px; padding: 2px 8px; border-radius: 4px; background: #e44d26; color: white;" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
          </form>
        </div>
      {% endif %}
    </div>

    {% if edit_review_id == review.id %}
  <form action="{% url 'review_update' review.id %}" method="post" enctype="multipart/form-data" style="margin-top: 15px; background: #fffbe6; padding: 15px; border-radius: 8px; border: 1px solid #ffe58f;">
    {% csrf_token %}
    
    <div style="margin-bottom: 10px;">
      <label style="font-size: 13px; font-weight: bold;">í‰ì  ìˆ˜ì •: </label>
      <select name="rating" style="padding: 3px; border-radius: 4px;">
        {% for i in "54321" %}
          <option value="{{ i }}" {% if review.rating|stringformat:"i" == i %}selected{% endif %}>{{ i }}ì </option>
        {% endfor %}
      </select>
    </div>

    <textarea name="content" required style="width: 100%; height: 80px; padding: 10px; border-radius: 5px; border: 1px solid #ddd; display: block; margin-bottom: 10px; box-sizing: border-box;">{{ review.content }}</textarea>

    {% if review.images.all %}
  <div style="margin-bottom: 20px;">
    <p style="font-size: 12px; font-weight: bold; margin-bottom: 8px;">ğŸ—‘ï¸ í˜„ì¬ ë“±ë¡ëœ ì‚¬ì§„ (ì‚­ì œí•˜ë ¤ë©´ ì„ íƒ):</p>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      {% for img in review.images.all %}
        <div style="text-align: center; border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: white;">
          <img src="{{ img.image.url }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; display: block; margin-bottom: 5px;">
          <input type="checkbox" name="delete_images" value="{{ img.id }}">
          <span style="font-size: 11px; color: #e44d26;">ì‚­ì œ</span>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<div style="margin-bottom: 15px;">
  <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">ğŸ“¸ ì‚¬ì§„ ì¶”ê°€ (ìµœëŒ€ 5ì¥)</label>
  <div class="image-upload-wrapper">
  {% for i in "12345" %}
    <div class="image-upload-box">
      <input type="file" name="review_images" accept="image/*" 
             onchange="if(this.value) this.parentElement.classList.add('has-file'); else this.parentElement.classList.remove('has-file');">
      <div class="upload-status-text">
        <span>No Image</span>
      </div>
    </div>
  {% endfor %}
</div>
  <p style="font-size: 11px; color: #888; margin-top: 5px;">* ì¶”ê°€í•˜ê³  ì‹¶ì€ ì¹¸ì„ í´ë¦­í•˜ì—¬ ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”.</p>
</div>

    <div style="display: flex; gap: 5px;">
      <button type="submit" style="background: #333; color: white; padding: 5px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">ìˆ˜ì • ì™„ë£Œ</button>
      <a href="?" style="background: #ccc; color: white; padding: 5px 12px; border: none; border-radius: 4px; text-decoration: none; font-size: 12px;">ì·¨ì†Œ</a>
    </div>
  </form>
{% else %}
      <p style="margin: 10px 0; line-height: 1.5;">{{ review.content }}</p>
      {% if review.images.all %}
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
          {% for img in review.images.all %}
            <img src="{{ img.image.url }}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px; border: 1px solid #eee;">
          {% endfor %}
        </div>
      {% endif %}
    {% endif %}
  </div>
{% endfor %}
    </div>
  </div>
</div>
{% endblock %}