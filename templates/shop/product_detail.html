{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'shop/css/shop.css' %}">
{% endblock %}

{% block content %}
<div class="detail-container">
    <a href="{% url 'product_list' %}" class="back-link">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    <div class="detail-top">
        <div class="detail-gallery">
            {% if product.image1 %}
                <img src="{{ product.image1.url }}" class="main-img">
            {% else %}
                <div class="no-img-box">ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            {% endif %}
            
            <div class="sub-img-grid">
                {% if product.image2 %}<img src="{{ product.image2.url }}" class="sub-img">{% endif %}
                {% if product.image3 %}<img src="{{ product.image3.url }}" class="sub-img">{% endif %}
                {% if product.image4 %}<img src="{{ product.image4.url }}" class="sub-img">{% endif %}
                {% if product.image5 %}<img src="{{ product.image5.url }}" class="sub-img">{% endif %}
            </div>
        </div>

        <div class="detail-info">
            <h1>{{ product.name }}</h1>
            <p class="price-tag">{{ product.price|intcomma }}ì›</p>
            <hr>
            <p class="description-short">{{ product.description }}</p>
            <p class="stock-info">ë‚¨ì€ ìˆ˜ëŸ‰: {{ product.stock }}ê°œ</p>
            
            <form method="post" class="purchase-form">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ product.id }}">
                <div class="review-current-imgs">
                    <label for="quantity">ìˆ˜ëŸ‰: </label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ product.stock }}" class="quantity-input">
                </div>
                <button type="submit" formaction="{% url 'add_to_cart' product.id %}" class="btn-cart">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                <button type="submit" formaction="{% url 'checkout' %}" class="btn-buy">ë°”ë¡œ êµ¬ë§¤í•˜ê¸°</button>
            </form>
        </div>
    </div>

    <hr class="product-detail-hr product-detail-hr-md">
    
    <div class="detail-content">
        <h3 class="product-detail-title">ìƒí’ˆ ìƒì„¸ ì„¤ëª…</h3>
        {% if product.description_image1 %}
            <img src="{{ product.description_image1.url }}" class="detail-desc-img">
        {% endif %}
        {% if product.description_image2 %}
            <img src="{{ product.description_image2.url }}" class="detail-desc-img">
        {% endif %}
        <p class="detail-desc-text">{{ product.description_text1 }}</p>
    </div>

    <hr class="product-detail-hr product-detail-hr-lg">

    <div id="review-section" class="review-section">
        {% if can_review %}
            <div class="review-form-card">
                <h4>ì´ ìƒí’ˆì€ ì–´ë– ì…¨ë‚˜ìš”?</h4>
                <form action="{% url 'review_create' product.id %}" method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    <div class="review-field">
                        <label>í‰ì : </label>
                        <select name="rating" class="review-rating-select">
                            <option value="5">â˜…â˜…â˜…â˜…â˜… (5ì )</option>
                            <option value="4">â˜…â˜…â˜…â˜… (4ì )</option>
                            <option value="3">â˜…â˜…â˜… (3ì )</option>
                            <option value="2">â˜…â˜… (2ì )</option>
                            <option value="1">â˜… (1ì )</option>
                        </select>
                    </div>

                    <div class="review-field">
                        <label class="review-photo-label">ğŸ“¸ ì‚¬ì§„ ì²¨ë¶€ (ìµœëŒ€ 5ì¥)</label>
                        <div class="image-upload-wrapper">
                            {% for i in "12345" %}
                                <div class="image-upload-box">
                                    <input type="file" name="review_images" accept="image/*" required 
                                           onchange="if(this.value) this.parentElement.classList.add('has-file'); else this.parentElement.classList.remove('has-file');">
                                    <div class="upload-status-text"><span>No Image</span></div>
                                </div>
                            {% endfor %}
                        </div>
                        <p class="review-photo-hint">* ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ ë°•ìŠ¤ ìƒ‰ìƒì´ ë³€ê²½ë©ë‹ˆë‹¤.</p>
                    </div>

                    <textarea name="content" placeholder="ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." class="review-textarea"></textarea>
                    <button type="submit" class="btn-cart review-submit-btn">ë¦¬ë·° ë“±ë¡í•˜ê¸°</button>
                </form>
            </div>
        {% endif %}

        <div class="review-list-wrap">
            {% for review in reviews %}
                <div class="review-item">
                    <div class="review-meta">
                        <div class="review-user-info">
                            <strong>{{ review.user.username }}</strong>
                            <span class="star-rating">â˜… {{ review.rating }}</span>
                            <span class="review-date">{{ review.created_at|date:"Y.m.d" }}</span>
                        </div>
                        
                        {% if review.user == request.user %}
                            <div class="review-owner-actions">
                                <a href="?edit_id={{ review.id }}#review-section" class="btn-recharge review-action-link">ìˆ˜ì •</a>
                                <form action="{% url 'review_delete' review.id %}" method="post" class="review-delete-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-pay review-delete-btn" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>

                    {% if edit_review_id == review.id %}
                        <form action="{% url 'review_update' review.id %}" method="post" enctype="multipart/form-data" class="edit-form-box">
                            {% csrf_token %}
                            <div class="review-edit-field">
                                <label class="review-edit-label">í‰ì  ìˆ˜ì •: </label>
                                <select name="rating" class="review-edit-select">
                                    {% for i in "54321" %}
                                        <option value="{{ i }}" {% if review.rating|stringformat:"i" == i %}selected{% endif %}>{{ i }}ì </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <textarea name="content" required class="review-textarea review-edit-textarea">{{ review.content }}</textarea>

                            {% if review.images.all %}
                                <div class="review-current-imgs">
                                    <p class="current-imgs-label">ğŸ—‘ï¸ í˜„ì¬ ë“±ë¡ëœ ì‚¬ì§„ (ì‚­ì œí•˜ë ¤ë©´ ì„ íƒ):</p>
                                    <div class="review-current-img-grid">
                                        {% for img in review.images.all %}
                                            <div class="img-delete-item">
                                                <img src="{{ img.image.url }}" class="review-current-img">
                                                <input type="checkbox" name="delete_images" value="{{ img.id }}">
                                                <span class="review-delete-tag">ì‚­ì œ</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}

                            <div class="review-field">
                                <label class="review-photo-label review-photo-label-sm">ğŸ“¸ ì‚¬ì§„ ì¶”ê°€ (ìµœëŒ€ 5ì¥)</label>
                                <div class="image-upload-wrapper">
                                    {% for i in "12345" %}
                                        <div class="image-upload-box">
                                            <input type="file" name="review_images" accept="image/*" 
                                                   onchange="if(this.value) this.parentElement.classList.add('has-file'); else this.parentElement.classList.remove('has-file');">
                                            <div class="upload-status-text"><span>No Image</span></div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="review-edit-actions">
                                <button type="submit" class="btn-submit-pay review-edit-submit-btn">ìˆ˜ì • ì™„ë£Œ</button>
                                <a href="?" class="btn-recharge review-edit-cancel-link">ì·¨ì†Œ</a>
                            </div>
                        </form>
                    {% else %}
                        <p class="review-content">{{ review.content }}</p>
                        {% if review.images.all %}
                            <div class="review-img-list">
                                {% for img in review.images.all %}
                                    <img src="{{ img.image.url }}">
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}