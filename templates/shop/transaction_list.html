{% extends "base.html" %}
{% load humanize %}

{% block content %}

<style>
  /* âœ… í”„ë¡œì íŠ¸(ë‚´ ì •ë³´ í˜ì´ì§€) í†¤ê³¼ ë§ì¶˜ íƒ­/ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .txWrap{
    max-width: 1000px;
    margin: 30px auto 60px auto;
    padding: 0 12px;
  }
  .divider{ height:1px; background:#eee; }
  .txTitleRow{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin: 0 0 16px 0;
  }
  .txTitle{
    margin:0;
    font-weight:900;
    letter-spacing:-1px;
    color:#111;
    font-size: 24px;
  }

  /* íƒ­ë°”: ë‚´ ì •ë³´ í˜ì´ì§€ì™€ ë™ì¼ í†¤ */
  .txTabbar{
    display:flex;
    gap:10px;
    padding:12px 14px;
    background:#333;
    color:#fff;
    border-bottom:1px solid rgba(255,255,255,.12);
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,.1);
    overflow:hidden;
  }
  .txTabbtn{
    appearance:none;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
    color:#fff;
    padding:8px 12px;
    border-radius:999px;
    cursor:pointer;
    font-weight:900;
    font-size:13px;
    opacity:.9;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    white-space:nowrap;
  }
  .txTabbtn[aria-current="page"]{
    background:rgba(255,255,255,.18);
    opacity:1;
  }

  /* ì¹´ë“œ */
  .txCard{
    margin-top: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,.1);
    border-radius: 20px;
    overflow: hidden;
    background: #fff;
    border: 1px solid #eee;
  }
  .txSection{
    padding: 22px;
  }

  .txHead{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    margin: 0 0 14px 0;
  }
  .txH3{
    margin:0;
    font-size:16px;
    font-weight:900;
    color:#333;
  }
  .txSub{
    font-size:12px;
    color:#888;
    font-weight:700;
  }

  /* í•„í„° ë°•ìŠ¤ */
  .txFilterBox{
    background:#fcfcfc;
    border:1px solid #eee;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 18px;
  }

  /* form control í†¤ ì •ë¦¬ */
  .txFilterBox .form-label{
    font-size:12px;
    font-weight:900;
    color:#666;
    margin-bottom:6px;
  }
  .txFilterBox .form-control,
  .txFilterBox .form-select,
  .txFilterBox .input-group-text{
    border:1px solid #ddd !important;
    border-radius:12px !important;
    font-size:13px;
    background:#fff;
  }
  .txFilterBox .input-group > .form-control{
    border-radius:12px !important;
  }
  .txFilterBox .input-group-text{
    color:#666;
    font-weight:800;
  }

  /* ì¡°íšŒ ë²„íŠ¼: í”„ë¡œì íŠ¸ í†¤ */
  .txBtn{
    width:100%;
    background:#333 !important;
    border:none !important;
    color:#fff !important;
    border-radius:12px !important;
    padding:10px 12px !important;
    font-weight:900 !important;
    font-size:15px !important;
  }

  /* âœ… [ì •ë¦¬] ìš”ì•½/í†µê³„ í•„í„° ì „ìš©: â€œì…ë ¥+ë²„íŠ¼â€ì„ í•œ ê·¸ë£¹ì²˜ëŸ¼ ë³´ì´ê²Œ */
  .txSummaryForm{
    row-gap: 12px;
  }
  .txSummaryForm .input-group{
    flex-wrap: nowrap; /* PCì—ì„œ ì›”~ì›” ì¤„ë°”ê¿ˆ ë°©ì§€ */
  }

  /* ì¹´í…Œê³ ë¦¬ + ë²„íŠ¼ì„ í•œ ë¼ì¸ì—ì„œ ë¶™ì—¬ ë³´ì´ê²Œ */
  .txSummaryRight{
    display:flex;
    gap:10px;
    align-items:flex-end;
  }
  .txSummaryRight .txSummarySelect{
    flex: 1;
    min-width: 220px;
  }
  .txSummaryActions{
    display:flex;
    gap:10px;
    align-items:stretch;
    flex-shrink:0;
  }
  /* ìš”ì•½ í•„í„°ì—ì„œë§Œ ë²„íŠ¼ì„ â€œì ë‹¹í•œ í¬ê¸°â€ë¡œ */
  .txSummaryActions .txBtn{
    width:auto;
    min-width: 104px;
    padding-left:16px !important;
    padding-right:16px !important;
    white-space:nowrap;
  }
  .txBtnSecondary{
    background:#666 !important;
  }

  /* âœ… [ì¶”ê°€] ìš”ì•½ ê·¸ë˜í”„ ì„œë¸Œíƒ­: ì•„ë˜ ì—¬ë°±ë§Œ ì‚´ì§ */
  .txChartTabbar{
    margin: 0 0 12px 0;
  }

  /* ëª¨ë°”ì¼: ì…ë ¥ì€ ì„¸ë¡œ, ë²„íŠ¼ì€ 2ê°œê°€ ê°™ì€ ì¤„ 2ì—´ */
  @media (max-width: 576px){
    .txSummaryForm .input-group{
      flex-wrap: wrap;
    }
    .txSummaryRight{
      flex-direction: column;
      align-items: stretch;
    }
    .txSummaryRight .txSummarySelect{
      min-width: 0;
    }
    .txSummaryActions .txBtn{
      flex:1;
      min-width: 0;
    }
  }

  /* í…Œì´ë¸” */
  .txTableWrap{
    border:1px solid #eee;
    border-radius:16px;
    overflow:hidden;
    background:#fff;
  }
  .txTable{
    margin:0;
    min-width: 860px;
  }
  .txTable thead{
    background:#f9f9f9;
    border-bottom:1px solid #eee;
  }
  .txTable th{
    color:#666;
    font-weight:900;
    font-size:12px;
    padding: 14px 14px;
    border-bottom:1px solid #eee !important;
    white-space:nowrap;
  }
  .txTable td{
    padding: 14px 14px;
    border-top:1px solid #f2f2f2 !important;
    vertical-align:middle;
    font-size:13px;
    color:#333;
  }
  .txMuted{
    color:#888;
    font-size:12px;
    font-weight:700;
  }
  .txBank{
    font-weight:900;
    color:#333;
    font-size:13px;
  }
  .txAcc{
    color:#888;
    font-size:12px;
    font-weight:700;
  }
  .txProduct{
    font-weight:900;
    color:#222;
  }
  .txAmountOut{
    font-weight:900;
    color:#dc3545;
    font-size:15px;
    white-space:nowrap;
  }
  .txAmountIn{
    font-weight:900;
    color:#28a745;
    font-size:15px;
    white-space:nowrap;
  }
  .txBadge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    border-radius:999px;
    background:#e78181;
    color:#333;
    font-size:12px;
    font-weight:900;
    white-space:nowrap;
  }
  .txBadge_Category{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    border-radius:999px;
    background:#dfdfdf;
    color:#0d0d0d;
    font-size:12px;
    font-weight:900;
    white-space:nowrap;
  }
    

  /* âœ… ì°¨íŠ¸ wrapper: canvasì— ë†’ì´ë¥¼ ì£¼ì§€ ì•Šê³  wrapperì—ë§Œ ë†’ì´ë¥¼ ê³ ì • */
  .txChartWrap{
    height: 280px;
    width: 100%;
  }
  .txChartWrap canvas{
    width: 100% !important;
    height: 100% !important;
    display:block;
  }

  /* âœ… í˜ì´ì§€ë„¤ì´ì…˜ ì „ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€ */
  .pagination .page-link {
    color: #333;
    border: 1px solid #eee;
    border-radius: 8px !important;
    margin: 0 2px;
    font-weight: 700;
    font-size: 13px;
  }
  .pagination .page-item.active .page-link {
    background-color: #333 !important;
    border-color: #333 !important;
    color: #fff !important;
  }

  @media (max-width: 576px){
    .txSection{ padding: 16px; }
    .txFilterBox{ padding: 14px; }
    .txTitle{ font-size: 20px; }
    .txChartWrap{ height: 240px; }
  }
</style>

<div class="txWrap">
  <div class="txTitleRow">
    <h2 class="txTitle">ë‚˜ì˜ ê±°ë˜ ë‚´ì—­</h2>
  </div>

  <div class="txTabbar" role="tablist" aria-label="ê±°ë˜ë‚´ì—­ íƒ­">
    <a href="?tab=in" class="txTabbtn" aria-current="{% if active_tab == 'in' %}page{% else %}false{% endif %}">ğŸ’° ì…ê¸ˆ ë‚´ì—­</a>
    <a href="?tab=out" class="txTabbtn" aria-current="{% if active_tab == 'out' %}page{% else %}false{% endif %}">ğŸ›ï¸ ì¶œê¸ˆ/êµ¬ë§¤ ë‚´ì—­</a>
    <a href="?tab=summary" class="txTabbtn" aria-current="{% if active_tab == 'summary' %}page{% else %}false{% endif %}">ğŸ“Š ìš”ì•½/í†µê³„</a>
  </div>

  <div class="txCard">
    <div class="txSection">

      {% if active_tab == 'out' %}
        <div class="txHead">
          <h3 class="txH3">ì¶œê¸ˆ/êµ¬ë§¤ ë‚´ì—­</h3>
          <div class="txSub">ê¸°ê°„ / ê³„ì¢Œ / ì¹´í…Œê³ ë¦¬ë¡œ ì¡°íšŒ</div>
        </div>

        <div class="txFilterBox">
          <form method="GET" class="row g-3 align-items-end">
            <input type="hidden" name="tab" value="out">

            <div class="col-lg-4 col-md-12">
              <label class="form-label">ì¡°íšŒ ê¸°ê°„</label>
              <div class="input-group input-group-sm">
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                <span class="input-group-text bg-white">~</span>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
              </div>
            </div>

            <div class="col-lg-3 col-md-6">
              <label class="form-label">ê²°ì œ ê³„ì¢Œ</label>
              <select name="account" class="form-select form-select-sm">
                <option value="">ëª¨ë“  ê³„ì¢Œ</option>
                {% for acc in accounts %}
                  <option value="{{ acc.id }}" {% if selected_account == acc.id|stringformat:"i" %}selected{% endif %}>
                    {{ acc.bank.name }} ({{ acc.masked_account_number }})
                  </option>
                {% endfor %}
              </select>
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="discounted" value="1" id="discounted_only"
                  {% if discounted == "1" %}checked{% endif %}>
                <label class="form-check-label" for="discounted_only">í• ì¸ ì ìš©ë§Œ ë³´ê¸°</label>
              </div>
            </div>

            <div class="col-lg-3 col-md-6">
              <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
              <select name="category" class="form-select form-select-sm">
                <option value="">ëª¨ë“  ì¹´í…Œê³ ë¦¬</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"i" %}selected{% endif %}>
                    {{ cat.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-lg-2 col-md-12">
              <button type="submit" class="btn btn-sm txBtn">ì¡°íšŒí•˜ê¸°</button>
            </div>
          </form>
        </div>

        <div class="table-responsive txTableWrap">
          <table class="table table-hover align-middle txTable">
            <thead>
              <tr>
                <th style="width: 15%;">ë‚ ì§œ</th>
                <th style="width: 25%;">ê²°ì œ ê³„ì¢Œ</th>
                <th>ìƒí’ˆëª…(ìˆ˜ëŸ‰)</th>
                <th class="text-end">ê¸ˆì•¡</th>
                <th class="text-center">ì¹´í…Œê³ ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              {% for tx in transactions %}
                {% if tx.tx_type == "OUT" %}
                  <tr style="cursor: default;">
                    <td>
                      <div class="txMuted">{{ tx.occurred_at|date:"Y-m-d" }}</div>
                      <div class="txMuted">{{ tx.occurred_at|date:"H:i" }}</div>
                    </td>
                    <td>
                      <div class="txBank">{{ tx.account.bank.name }}</div>
                      <div class="txAcc">{{ tx.account.masked_account_number }}</div>
                    </td>
                    <td class="txProduct">{% if tx.product %}{{ tx.product.name }} <span class="txMuted" style="font-weight:800;">({{ tx.quantity }}ê°œ)</span>{% else %}{{ tx.product_name|default:"ì¼ë°˜ ì§€ì¶œ" }}{% endif %}
                      {% if tx.used_coupon or tx.discount_amount %}
  <span class="txBadge">í• ì¸</span>
{% endif %}

                    </td>
                    <td class="text-end txAmountOut">-{{ tx.amount|intcomma }}ì›</td>
                    <td class="text-center"><span class="txBadge_Category">{{ tx.category.name|default:"ë¯¸ë¶„ë¥˜" }}</span></td>
                  </tr>
                {% endif %}
              {% empty %}
                <tr><td colspan="5" class="text-center py-5 txMuted">ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      {% elif active_tab == 'summary' %}
        <div class="txHead">
          <h3 class="txH3">ìš”ì•½/í†µê³„</h3>
          <div class="txSub">ë‚´ ê³„ì •ì˜ ì „ì²´ ìˆ˜ìµ/ì§€ì¶œì„ ìš”ì•½í•©ë‹ˆë‹¤.</div>
        </div>

        <div class="txFilterBox">
          <!-- âœ… ë²„íŠ¼ì´ ë©€ë¦¬ ë–¨ì–´ì§€ì§€ ì•Šê²Œ â€œì¹´í…Œê³ ë¦¬+ë²„íŠ¼â€ì„ í•œ ê·¸ë£¹ìœ¼ë¡œ -->
          <form method="GET" class="txSummaryForm row g-3">
            <input type="hidden" name="tab" value="summary">

            {% if start_date %}<input type="hidden" name="start_date" value="{{ start_date }}">{% endif %}
            {% if end_date %}<input type="hidden" name="end_date" value="{{ end_date }}">{% endif %}
            {% if selected_account %}<input type="hidden" name="account" value="{{ selected_account }}">{% endif %}
            {% if selected_category %}<input type="hidden" name="category" value="{{ selected_category }}">{% endif %}

            {# âœ… ì°¨íŠ¸ ì„œë¸Œíƒ­ ìœ ì§€ìš© íŒŒë¼ë¯¸í„° #}
            <input type="hidden" name="chart_tab" value="{{ request.GET.chart_tab|default:'monthly' }}">

            <div class="col-lg-6 col-md-12">
              <label class="form-label">ì›” ë²”ìœ„(ì›”ë³„ ìˆ˜ìµ/ì§€ì¶œ)</label>
              <div class="input-group input-group-sm">
                <input type="month" name="sum_start" class="form-control" value="{{ sum_start }}">
                <span class="input-group-text bg-white">~</span>
                <input type="month" name="sum_end" class="form-control" value="{{ sum_end }}">
              </div>
            </div>

            <div class="col-lg-6 col-md-12">
              <div class="txSummaryRight">
                <div class="txSummarySelect">
                  <label class="form-label">ì§€ì¶œ ì¹´í…Œê³ ë¦¬(ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ)</label>
                  <select name="sum_category" class="form-select form-select-sm">
                    <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                    {% for cat in categories %}
                      <option value="{{ cat.id }}" {% if sum_category == cat.id|stringformat:"i" %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="txSummaryActions">
                  <button type="submit" class="btn btn-sm txBtn">ì ìš©</button>
                  <a href="?tab=summary&reset=1" class="btn btn-sm txBtn txBtnSecondary">ì´ˆê¸°í™”</a>
                </div>
              </div>
            </div>
          </form>
        </div>

        <div class="row g-3" style="margin-bottom: 18px;">
          <div class="col-md-4"><div class="txFilterBox" style="margin-bottom:0;"><div class="txMuted" style="font-weight:900;">ì´ ìˆ˜ìµ(ì…ê¸ˆ)</div><div class="txAmountIn" style="font-size:20px;">+{{ total_in|intcomma }}ì›</div></div></div>
          <div class="col-md-4"><div class="txFilterBox" style="margin-bottom:0;"><div class="txMuted" style="font-weight:900;">ì´ ì§€ì¶œ(ì¶œê¸ˆ)</div><div class="txAmountOut" style="font-size:20px;">-{{ total_out|intcomma }}ì›</div></div></div>
          <div class="col-md-4"><div class="txFilterBox" style="margin-bottom:0;"><div class="txMuted" style="font-weight:900;">ìˆœì´ìµ</div><div style="font-weight:900; font-size:20px; color:#333;">{{ net_total|intcomma }}ì›</div></div></div>
        </div>

        {% with chart_tab=request.GET.chart_tab|default:"monthly" %}
        <div class="divider" style="margin:18px 0;"></div>
        <div class="txHead"><h3 class="txH3">ìš”ì•½/í†µê³„(Graph)</h3><div class="txSub">ìš”ì•½ ì •ë³´ì˜ ê·¸ë˜í”„ì…ë‹ˆë‹¤.</div></div>
        <div class="txTabbar txChartTabbar" role="tablist">
          <a href="?tab=summary&chart_tab=monthly{% if sum_start %}&sum_start={{ sum_start }}{% endif %}{% if sum_end %}&sum_end={{ sum_end }}{% endif %}{% if sum_category %}&sum_category={{ sum_category }}{% endif %}" class="txTabbtn" aria-current="{% if chart_tab == 'monthly' %}page{% else %}false{% endif %}">ğŸ“ˆ ìˆ˜ìµ/ì§€ì¶œ í†µê³„</a>
          <a href="?tab=summary&chart_tab=category{% if sum_start %}&sum_start={{ sum_start }}{% endif %}{% if sum_end %}&sum_end={{ sum_end }}{% endif %}{% if sum_category %}&sum_category={{ sum_category }}{% endif %}" class="txTabbtn" aria-current="{% if chart_tab == 'category' %}page{% else %}false{% endif %}">ğŸ§¾ ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í†µê³„</a>
        </div>
        {% if chart_tab == 'monthly' %}
          <div class="txFilterBox"><div class="txMuted" style="font-weight:900; margin-bottom: 8px;">ìˆ˜ìµ/ì§€ì¶œ í†µê³„</div><div class="txChartWrap">
            {% if has_summary_data %}
              {% if has_category_data %}
  <canvas id="txCategoryChart"
          data-labels="{{ cat_chart_labels|escape }}"
          data-values="{{ cat_chart_values|escape }}"></canvas>
{% else %}
  <div class="txChartWrap" style="height:260px; display:flex; align-items:center; justify-content:center; border:1px dashed #ddd; border-radius:16px; background:#fafafa; text-align:center;">
    <div>
      <div style="font-weight:900; color:#555;">ğŸ§¾ ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
      <div class="txMuted" style="font-size:13px;">ì§€ì¶œ ë‚´ì—­ì´ ìƒê¸°ë©´ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </div>
{% endif %}
{% else %}
  <div class="txChartWrap" style="height:260px; display:flex; align-items:center; justify-content:center; border:1px dashed #ddd; border-radius:16px; background:#fafafa; text-align:center;">
    <div>
      <div style="font-weight:900; color:#555;">ğŸ“‰ í‘œì‹œí•  ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
      <div class="txMuted" style="font-size:13px;">ê±°ë˜ ë‚´ì—­ì´ ìƒê¸°ë©´ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </div>
{% endif %}
          </div>
        </div>
        {% else %}
  <div class="txFilterBox">
    <div class="txMuted" style="font-weight:900; margin-bottom: 8px;">ì¹´í…Œê³ ë¦¬ë³„ í†µê³„</div>

    {% if has_summary_data %}
      {% if has_category_data %}
        <div class="txChartWrap">
          <canvas id="txCategoryChart"
                  data-labels="{{ cat_chart_labels|escape }}"
                  data-values="{{ cat_chart_values|escape }}"></canvas>
        </div>
      {% else %}
        <div class="txChartWrap" style="height:260px; display:flex; align-items:center; justify-content:center; border:1px dashed #ddd; border-radius:16px; background:#fafafa; text-align:center;">
          <div>
            <div style="font-weight:900; color:#555;">ğŸ§¾ ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="txMuted" style="font-size:13px;">ì§€ì¶œ ë‚´ì—­ì´ ìƒê¸°ë©´ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
        </div>
      {% endif %}
    {% else %}
      <div class="txChartWrap" style="height:260px; display:flex; align-items:center; justify-content:center; border:1px dashed #ddd; border-radius:16px; background:#fafafa; text-align:center;">
        <div>
          <div style="font-weight:900; color:#555;">ğŸ“‰ í‘œì‹œí•  ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          <div class="txMuted" style="font-size:13px;">ê±°ë˜ ë‚´ì—­ì´ ìƒê¸°ë©´ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}

        {% endwith %}

        {# âœ… Chart.js: í˜„ì¬ í‘œì‹œë˜ëŠ” canvasë§Œ ë Œë” #}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          (function(){
            const mCanvas = document.getElementById('txMonthlyChart');
            const cCanvas = document.getElementById('txCategoryChart');

            // ===== ì›”ë³„ ìˆ˜ìµ/ì§€ì¶œ =====
            if (mCanvas) {
              const labels = (mCanvas.dataset.labels || '').split('|').filter(Boolean).map(s => s.trim());
              const inVals = (mCanvas.dataset.in || '').split('|').filter(Boolean).map(Number);
              const outVals = (mCanvas.dataset.out || '').split('|').filter(Boolean).map(Number);
              if (labels.length) { new Chart(mCanvas, { type: 'bar', data: { labels: labels, datasets: [{ label: 'ìˆ˜ìµ(ì…ê¸ˆ)', data: inVals, borderWidth: 1 }, { label: 'ì§€ì¶œ(ì¶œê¸ˆ)', data: outVals, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); }
            }

            // ===== ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ =====
            if (cCanvas) {
              const labels = (cCanvas.dataset.labels || '').split('|').filter(Boolean).map(s => s.trim());
              const vals = (cCanvas.dataset.values || '').split('|').filter(Boolean).map(Number);

              if (labels.length) { new Chart(cCanvas, { type: 'bar', data: { labels: labels, datasets: [{ label: 'ì§€ì¶œ(ì¶œê¸ˆ)', data: vals, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); }
            }
          })();
        </script>

      {% else %}
        <div class="txHead">
          <h3 class="txH3">ì…ê¸ˆ ë‚´ì—­</h3>
          <div class="txSub">ê³„ì¢Œ ì¶©ì „ ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <div class="txFilterBox">
          <form method="GET" class="row g-3 align-items-end">
            <input type="hidden" name="tab" value="in">
            <div class="col-lg-5 col-md-12">
              <label class="form-label">ì¡°íšŒ ê¸°ê°„</label>
              <div class="input-group input-group-sm">
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                <span class="input-group-text bg-white">~</span>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
              </div>
            </div>
            <div class="col-lg-5 col-md-12">
              <label class="form-label">ì…ê¸ˆ ê³„ì¢Œ</label>
              <select name="account" class="form-select form-select-sm">
                <option value="">ëª¨ë“  ê³„ì¢Œ</option>
                {% for acc in accounts %}
                  <option value="{{ acc.id }}" {% if selected_account == acc.id|stringformat:"i" %}selected{% endif %}>{{ acc.bank.name }} ({{ acc.masked_account_number }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-2 col-md-12">
              <button type="submit" class="btn btn-sm txBtn">ì¡°íšŒí•˜ê¸°</button>
            </div>
          </form>
        </div>

        <div class="table-responsive txTableWrap">
          <table class="table table-hover align-middle txTable">
            <thead>
              <tr>
                <th style="width: 20%;">ë‚ ì§œ</th>
                <th style="width: 35%;">ì…ê¸ˆ ê³„ì¢Œ</th>
                <th>ë‚´ìš©</th>
                <th class="text-end" style="width: 20%;">ê¸ˆì•¡</th>
              </tr>
            </thead>
            <tbody>
              {% for tx in transactions %}
                {% if tx.tx_type == "IN" %}
                  <tr style="cursor: default;">
                    <td><div class="txMuted">{{ tx.occurred_at|date:"Y-m-d" }}</div><div class="txMuted">{{ tx.occurred_at|date:"H:i" }}</div></td>
                    <td><div class="txBank">{{ tx.account.bank.name }}</div><div class="txAcc">{{ tx.account.masked_account_number }}</div></td>
                    <td class="txProduct"><span class="txBadge_Category" style="margin-right: 8px;">ì…ê¸ˆ</span>{{ tx.product_name|default:"ê³„ì¢Œ ì¶©ì „" }}</td>
                    <td class="text-end txAmountIn">+{{ tx.amount|intcomma }}ì›</td>
                  </tr>
                {% endif %}
              {% empty %}
                <tr><td colspan="4" class="text-center py-5 txMuted">ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
      {% if active_tab != 'summary' and is_paginated %}
        <div style="display: flex; justify-content: center; margin: 40px 0; gap: 8px;">

          {# [ì´ì „] ë²„íŠ¼ #}
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&tab={{ active_tab }}&account={{ selected_account|default:'' }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&category={{ selected_category|default:'' }}" 
               style="padding: 10px 15px; border: 1px solid #eee; border-radius: 6px; text-decoration: none; color: #666; font-size: 14px; background: white; font-weight: 700;">
               ì´ì „
            </a>
          {% endif %}

          {# [í˜„ì¬ í˜ì´ì§€ / ì´ í˜ì´ì§€] í‘œì‹œ #}
          <span style="padding: 10px 20px; background: #333; color: white; border-radius: 6px; font-weight: bold; font-size: 14px; display: flex; align-items: center;">
            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
          </span>

          {# [ë‹¤ìŒ] ë²„íŠ¼ #}
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&tab={{ active_tab }}&account={{ selected_account|default:'' }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&category={{ selected_category|default:'' }}" 
               style="padding: 10px 15px; border: 1px solid #eee; border-radius: 6px; text-decoration: none; color: #666; font-size: 14px; background: white; font-weight: 700;">
               ë‹¤ìŒ
            </a>
          {% endif %}

        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
