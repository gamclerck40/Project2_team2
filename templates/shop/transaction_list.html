{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'shop/css/transaction.css' %}">
{% endblock %}

{% block content %}
<div class="txWrap">
  <div class="txTitleRow">
    <h2 class="txTitle">ë‚˜ì˜ ê±°ë˜ ë‚´ì—­</h2>
  </div>

  <div class="txTabbar" role="tablist" aria-label="ê±°ë˜ë‚´ì—­ íƒ­">
    <a href="?tab=in" class="txTabbtn" aria-current="{% if active_tab == 'in' %}page{% else %}false{% endif %}">ğŸ’° ì…ê¸ˆ ë‚´ì—­</a>
    <a href="?tab=out" class="txTabbtn" aria-current="{% if active_tab == 'out' %}page{% else %}false{% endif %}">ğŸ›ï¸ ì¶œê¸ˆ/êµ¬ë§¤ ë‚´ì—­</a>
    <a href="?tab=summary" class="txTabbtn" aria-current="{% if active_tab == 'summary' %}page{% else %}false{% endif %}">ğŸ“Š ìš”ì•½/í†µê³„</a>
  </div>

  <div class="txCard">
    <div class="txSection">

      {% if active_tab == 'out' %}
        <div class="txHead">
          <h3 class="txH3">ì¶œê¸ˆ/êµ¬ë§¤ ë‚´ì—­</h3>
          <div class="txSub">ê¸°ê°„ / ê³„ì¢Œ / ì¹´í…Œê³ ë¦¬ë¡œ ì¡°íšŒ</div>
        </div>

        <div class="txFilterBox">
          <form method="GET" class="txForm">
  <input type="hidden" name="tab" value="in">

  <div class="txGrid">
    <div class="txField txField--range">
      <label class="txLabel">ì¡°íšŒ ê¸°ê°„</label>
      <div class="txRange">
        <input type="date" name="start_date" class="txInput" value="{{ start_date }}">
        <span class="txRangeSep">~</span>
        <input type="date" name="end_date" class="txInput" value="{{ end_date }}">
      </div>
    </div>

    <div class="txField">
      <label class="txLabel">ì…ê¸ˆ ê³„ì¢Œ</label>
      <select name="account" class="txSelect">
        <option value="">ëª¨ë“  ê³„ì¢Œ</option>
        {% for acc in accounts %}
          <option value="{{ acc.id }}" {% if selected_account == acc.id|stringformat:"i" %}selected{% endif %}>
            {{ acc.bank.name }} ({{ acc.account_number }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="txField txField--action">
      <button type="submit" class="txBtn">ì¡°íšŒí•˜ê¸°</button>
    </div>
  </div>
</form>

        </div>

        <div class="table-responsive txTableWrap">
          <table class="table table-hover align-middle txTable">
            <thead>
              <tr>
                <th style="width: 15%;">ë‚ ì§œ</th>
                <th style="width: 25%;">ê²°ì œ ê³„ì¢Œ</th>
                <th>ìƒí’ˆëª…(ìˆ˜ëŸ‰)</th>
                <th class="text-end">ê¸ˆì•¡</th>
                <th class="text-center">ì¹´í…Œê³ ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              {% for tx in transactions %}
                {% if tx.tx_type == "OUT" %}
                  <tr style="cursor: default;">
                    <td>
                      <div class="txMuted">{{ tx.occurred_at|date:"Y-m-d" }}</div>
                      <div class="txMuted">{{ tx.occurred_at|date:"H:i" }}</div>
                    </td>
                    <td>
                      <div class="txBank">{{ tx.account.bank.name }}</div>
                      <div class="txAcc">{{ tx.account.masked_account_number }}</div>
                    </td>
                    <td class="txProduct">{% if tx.product %}{{ tx.product.name }} <span class="txMuted" style="font-weight:800;">({{ tx.quantity }}ê°œ)</span>{% else %}{{ tx.product_name|default:"ì¼ë°˜ ì§€ì¶œ" }}{% endif %}</td>
                    <td class="text-end txAmountOut">-{{ tx.amount|intcomma }}ì›</td>
                    <td class="text-center"><span class="txBadge">{{ tx.category.name|default:"ë¯¸ë¶„ë¥˜" }}</span></td>
                  </tr>
                {% endif %}
              {% empty %}
                <tr><td colspan="5" class="text-center py-5 txMuted">ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      {% elif active_tab == 'summary' %}
        <div class="txHead">
          <h3 class="txH3">ìš”ì•½/í†µê³„</h3>
          <div class="txSub">ë‚´ ê³„ì •ì˜ ì „ì²´ ìˆ˜ìµ/ì§€ì¶œì„ ìš”ì•½í•©ë‹ˆë‹¤.</div>
        </div>

        <div class="txFilterBox">
          <form method="GET" class="txSummaryForm row g-3">
            <input type="hidden" name="tab" value="summary">
            {% if start_date %}<input type="hidden" name="start_date" value="{{ start_date }}">{% endif %}
            {% if end_date %}<input type="hidden" name="end_date" value="{{ end_date }}">{% endif %}
            {% if selected_account %}<input type="hidden" name="account" value="{{ selected_account }}">{% endif %}
            {% if selected_category %}<input type="hidden" name="category" value="{{ selected_category }}">{% endif %}
            <input type="hidden" name="chart_tab" value="{{ request.GET.chart_tab|default:'monthly' }}">

            <div class="col-lg-6 col-md-12">
              <label class="form-label">ì›” ë²”ìœ„(ì›”ë³„ ìˆ˜ìµ/ì§€ì¶œ)</label>
              <div class="input-group input-group-sm">
                <input type="month" name="sum_start" class="form-control" value="{{ sum_start }}">
                <span class="input-group-text bg-white">~</span>
                <input type="month" name="sum_end" class="form-control" value="{{ sum_end }}">
              </div>
            </div>

            <div class="col-lg-6 col-md-12">
              <div class="txSummaryRight">
                <div class="txSummarySelect">
                  <label class="form-label">ì§€ì¶œ ì¹´í…Œê³ ë¦¬(ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ)</label>
                  <select name="sum_category" class="form-select form-select-sm">
                    <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                    {% for cat in categories %}
                      <option value="{{ cat.id }}" {% if sum_category == cat.id|stringformat:"i" %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="txSummaryActions">
                  <button type="submit" class="btn btn-sm txBtn">ì ìš©</button>
                  <a href="?tab=summary" class="btn btn-sm txBtn txBtnSecondary">ì´ˆê¸°í™”</a>
                </div>
              </div>
            </div>
          </form>
        </div>

        {% if has_summary_data %}
<div class="row g-3" style="margin-bottom: 18px;">
          <div class="col-md-4"><div class="txFilterBox" style="margin-bottom:0;"><div class="txMuted" style="font-weight:900;">ì´ ìˆ˜ìµ(ì…ê¸ˆ)</div><div class="txAmountIn" style="font-size:20px;">+{{ total_in|intcomma }}ì›</div></div></div>
          <div class="col-md-4"><div class="txFilterBox" style="margin-bottom:0;"><div class="txMuted" style="font-weight:900;">ì´ ì§€ì¶œ(ì¶œê¸ˆ)</div><div class="txAmountOut" style="font-size:20px;">-{{ total_out|intcomma }}ì›</div></div></div>
          <div class="col-md-4"><div class="txFilterBox" style="margin-bottom:0;"><div class="txMuted" style="font-weight:900;">ìˆœì´ìµ</div><div style="font-weight:900; font-size:20px; color:#333;">{{ net_total|intcomma }}ì›</div></div></div>
        </div>

{% with chart_tab=request.GET.chart_tab|default:"monthly" %}
  <div class="divider tx-divider-md"></div>
  <div class="txHead">
    <h3 class="txH3">ìš”ì•½/í†µê³„(Graph)</h3>
    <div class="txSub">ìš”ì•½ ì •ë³´ì˜ ê·¸ë˜í”„ì…ë‹ˆë‹¤.</div>
  </div>

  <div class="txTabbar txChartTabbar" role="tablist">
    <a href="?tab=summary&chart_tab=monthly{% if sum_start %}&sum_start={{ sum_start }}{% endif %}{% if sum_end %}&sum_end={{ sum_end }}{% endif %}{% if sum_category %}&sum_category={{ sum_category }}{% endif %}"
       class="txTabbtn"
       aria-current="{% if chart_tab == 'monthly' %}page{% else %}false{% endif %}">ğŸ“ˆ ìˆ˜ìµ/ì§€ì¶œ í†µê³„</a>

    <a href="?tab=summary&chart_tab=category{% if sum_start %}&sum_start={{ sum_start }}{% endif %}{% if sum_end %}&sum_end={{ sum_end }}{% endif %}{% if sum_category %}&sum_category={{ sum_category }}{% endif %}"
       class="txTabbtn"
       aria-current="{% if chart_tab == 'category' %}page{% else %}false{% endif %}">ğŸ§¾ ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í†µê³„</a>
  </div>

  {% if chart_tab == 'monthly' %}
    {% if chart_labels %}
      <div class="txFilterBox">
        <div class="txMuted tx-chart-title">ìˆ˜ìµ/ì§€ì¶œ í†µê³„</div>
        <div class="txChartWrap">
          <canvas id="txMonthlyChart"
                  data-labels="{{ chart_labels|escape }}"
                  data-in="{{ chart_in|escape }}"
                  data-out="{{ chart_out|escape }}"></canvas>
        </div>
      </div>
    {% else %}
      <div class="txFilterBox">
        <div class="txChartEmpty">
          <div class="txChartEmptyTitle">í‘œì‹œí•  ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          <div class="txChartEmptySub">ê±°ë˜ ë‚´ì—­ì´ ìƒê¸°ë©´ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>
    {% endif %}

  {% else %}
    {% if has_category_data %}
      <div class="txFilterBox">
        <div class="txMuted tx-chart-title">ì¹´í…Œê³ ë¦¬ë³„ í†µê³„</div>
        <div class="txChartWrap">
          <canvas id="txCategoryChart"
                  data-labels="{{ cat_chart_labels|escape }}"
                  data-values="{{ cat_chart_values|escape }}"></canvas>
        </div>
      </div>
    {% else %}
      <div class="txFilterBox">
        <div class="txChartEmpty">
          <div class="txChartEmptyTitle">í‘œì‹œí•  ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          <div class="txChartEmptySub">í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ì§€ì¶œ ë‚´ì—­ì´ ìƒê¸°ë©´ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endwith %}


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          (function(){
            const mCanvas = document.getElementById('txMonthlyChart');
            const cCanvas = document.getElementById('txCategoryChart');
            if (mCanvas) {
              const labels = (mCanvas.dataset.labels || '').split('|').filter(Boolean).map(s => s.trim());
              const inVals = (mCanvas.dataset.in || '').split('|').filter(Boolean).map(Number);
              const outVals = (mCanvas.dataset.out || '').split('|').filter(Boolean).map(Number);
              if (labels.length) { new Chart(mCanvas, { type: 'bar', data: { labels: labels, datasets: [{ label: 'ìˆ˜ìµ(ì…ê¸ˆ)', data: inVals, borderWidth: 1 }, { label: 'ì§€ì¶œ(ì¶œê¸ˆ)', data: outVals, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); }
            }
            if (cCanvas) {
  const labels = (cCanvas.dataset.labels || '').split('|').filter(Boolean).map(s => s.trim());
  const vals = (cCanvas.dataset.values || '').split('|').filter(Boolean).map(Number);

  if (labels.length) {
    // âœ… ì¹´í…Œê³ ë¦¬ ê°œìˆ˜ë§Œí¼ ìƒ‰ ìë™ ìƒì„±
    const colors = labels.map((_, i) => {
      const hue = (i * 47) % 360;  // ë³´ê¸° ì¢‹ì€ ê°„ê²©ìœ¼ë¡œ ìƒ‰ìƒ ë¶„ì‚°
      return `hsl(${hue}, 70%, 60%)`;
    });

    new Chart(cCanvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'ì§€ì¶œ(ì¶œê¸ˆ)',
          data: vals,
          backgroundColor: colors,   // âœ… ë§‰ëŒ€ë§ˆë‹¤ ë‹¤ë¥¸ ìƒ‰
          borderColor: colors.map(c => c.replace('60%', '45%')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: {
          legend: { display: false } // ë§‰ëŒ€ë³„ ìƒ‰ì´ ë‹¤ë¥´ë¯€ë¡œ ë²”ë¡€ ìˆ¨ê¹€
        }
      }
    });
  }
}
          })();
        </script>
{% else %}
  <div class="txFilterBox"><div class="txMuted" style="font-weight:900;">ìš”ì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>
{% endif %}

      {% else %}
        <div class="txHead">
          <h3 class="txH3">ì…ê¸ˆ ë‚´ì—­</h3>
          <div class="txSub">ê³„ì¢Œ ì¶©ì „ ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <div class="txFilterBox">
          <form method="GET" class="txForm">
  <input type="hidden" name="tab" value="out">

  <div class="txGrid txGrid--out">
    <div class="txField txField--range">
      <label class="txLabel">ì¡°íšŒ ê¸°ê°„</label>
      <div class="txRange">
        <input type="date" name="start_date" class="txInput" value="{{ start_date }}">
        <span class="txRangeSep">~</span>
        <input type="date" name="end_date" class="txInput" value="{{ end_date }}">
      </div>
    </div>

    <div class="txField">
      <label class="txLabel">ê²°ì œ ê³„ì¢Œ</label>
      <select name="account" class="txSelect">
        <option value="">ëª¨ë“  ê³„ì¢Œ</option>
        {% for acc in accounts %}
          <option value="{{ acc.id }}" {% if selected_account == acc.id|stringformat:"i" %}selected{% endif %}>
            {{ acc.bank.name }} ({{ acc.masked_account_number }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="txField">
      <label class="txLabel">ì¹´í…Œê³ ë¦¬</label>
      <select name="category" class="txSelect">
        <option value="">ëª¨ë“  ì¹´í…Œê³ ë¦¬</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"i" %}selected{% endif %}>
            {{ cat.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="txField">
      <label class="txLabel">í• ì¸</label>
      <select name="discounted" class="txSelect">
        <option value="" {% if not discounted %}selected{% endif %}>ì „ì²´</option>
        <option value="1" {% if discounted == "1" %}selected{% endif %}>í• ì¸ ê±°ë˜ë§Œ</option>
      </select>
    </div>

    <div class="txField txField--action">
      <button type="submit" class="txBtn">ì¡°íšŒí•˜ê¸°</button>
    </div>
  </div>
</form>

        </div>

        <div class="table-responsive txTableWrap">
          <table class="table table-hover align-middle txTable">
            <thead>
              <tr>
                <th style="width: 20%;">ë‚ ì§œ</th>
                <th style="width: 35%;">ì…ê¸ˆ ê³„ì¢Œ</th>
                <th>ë‚´ìš©</th>
                <th class="text-end" style="width: 20%;">ê¸ˆì•¡</th>
              </tr>
            </thead>
            <tbody>
              {% for tx in transactions %}
                {% if tx.tx_type == "IN" %}
                  <tr style="cursor: default;">
                    <td><div class="txMuted">{{ tx.occurred_at|date:"Y-m-d" }}</div><div class="txMuted">{{ tx.occurred_at|date:"H:i" }}</div></td>
                    <td><div class="txBank">{{ tx.account.bank.name }}</div><div class="txAcc">{{ tx.account.masked_account_number }}</div></td>
                    <td class="txProduct"><span class="txBadge" style="margin-right: 8px;">ì…ê¸ˆ</span>{{ tx.product_name|default:"ê³„ì¢Œ ì¶©ì „" }}</td>
                    <td class="text-end txAmountIn">+{{ tx.amount|intcomma }}ì›</td>
                  </tr>
                {% endif %}
              {% empty %}
                <tr><td colspan="4" class="text-center py-5 txMuted">ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {% if active_tab != 'summary' and is_paginated %}
  <div class="txPagination">
    {% if page_obj.has_previous %}
      <a class="txPageBtn" href="?page={{ page_obj.previous_page_number }}&tab={{ active_tab }}&account={{ selected_account|default:'' }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&category={{ selected_category|default:'' }}&discounted={{ discounted|default:'' }}">
        ì´ì „
      </a>
    {% endif %}

    <span class="txPageStat">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
      <a class="txPageBtn" href="?page={{ page_obj.next_page_number }}&tab={{ active_tab }}&account={{ selected_account|default:'' }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&category={{ selected_category|default:'' }}&discounted={{ discounted|default:'' }}">
        ë‹¤ìŒ
      </a>
    {% endif %}
  </div>
{% endif %}

    </div>
  </div>
</div>
{% endblock %}